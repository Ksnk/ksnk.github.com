# Визуализация и расчет траектории движения манипулятора

## Постановка задачи

### примерная схема манипулятора и определения

Манипулятор представляет собой жесткую платформу, к которой в фиксированных местах
прикреплены 2 узла с шаговыми двигателями. К узлам прикрепляются тяги (`активные тяги`), к тягам на пассивных
шарнирах - дополнительные тяги (`пассивные тяги`), соединяющиеся между собой. В точке соединения
располагается `активный элемент` манипулятора (АЭ), например, магнитный захват.

Управление манипулятором (перемещение активного элемента) ведется путем изменения угла поворота шаговых двигателей.

При движении манипулятора требуется избегать "точки потери управления" - состояния манипулятора, при котором угол 
между пассивными тягами = 180 градусов. Таким образом, можно считать, что угол между 
пассивными тягами всегда "смотрит вверх" - при определении точки расположения АЭ по углу поворота тяг выбираем 
решение с максимальной координатой Y.

Это условие - одно из `граничных условий`. В дополнение к нему возможно наличие преград, которые 
декларативно урезают ОП.

### Еще определения. Почти математика.

`Операционное пространство` манипулятора (ОП). ОП назовем все точки, в которые 
можно переместить АЭ. 
Конструктивно, пара угловых значений активных тяг манипулятора однозначно 
определяет точку ОП.
В то же время, каждая точка ОП характеризуется парой угловых значений 
каждой активной тяги манипулятора. (всего 4 пары координат для одной точки). Иногда, в силу 
граничных условий, некоторые комбинации пар недоступны. 

Рассмотрим пару точек А и Б из ОП. Поместим в точку А АЭ. 
Тем самым мы фиксируем координатную пару точки А. Для каждого комплекта координат B 
линейно и непрерывно изменяем угловые значения. 
Если для какой то пары координат Б в каждой точке получившегося пути 
граничные условия соблюдаются - считаем, что точки соединены `простым путем`. 

`Простой маршрут` между точками А и Б операционного пространства - набор точек ОП, между 
которыми существует простой путь.

### лемма.
Для ОП, любую пару точек можно соединить простым маршрутом.

#### вывод
Поиск такого маршрута и будет целью программы.  

## задача программы

_Обеспечить_
- визуализацию движений манипулятора по  заданной программе
- изменение, в разумных пределах, геометрии манипулятора
(размер тяг, расстояние между узлами, геометрия операционного поля)
- расчет программы движения манипулятора между заданными точками
- сохранение результатов расчета в удобном виде (csv ?)
- редактирование операционного поля манипулятора - расстановка и изменение формы препятствий,
указание начальной и конечной точки маршрута.

### Дополнительные соглашения

_Могут быть отменены или расширены в процессе доработки программы расчета._

При расчете и визуализации считаем, что 2 шарнира располагаются строго горизонтально (ось Х). 
Направление, параллельное оси У для обоих шаговых двигателей, считаем углом 0.

При расчете траектории движения активного элемента при наличии "преград" не учитываем остальные элементы
манипулятора, считаем, что эти элементы находятся "выше".

При расчете движений, для исключения ситуации "потери контроля", избегаем движений, при которых угол
пассивных тяг, соединяющих активный элемент, превосходит 175 градусов

Препятствия, в первой редакции программы, для упрощения интерфейса будем считать круглыми,
либо квадратными. Если требуется более сложная форма препятствий, их можно разместить
несколько рядом

## Решение

Программа представлена в виде html файла, пригодного для просмотра обычным современным
браузером. Расчетная часть, анимация и коммуникация с пользователем выполнена на javascript.
Результаты расчета сохраняются браузером пользователя на компьютере пользователя.
Работа с программой может быть продолжена после повторного открытия страницы с программой.

В целях упрощения знакомства с алгоритмами, а также в традициях броузерных страниц, разделена на несколько связанных между собой файлов
- index.html - основной файл с разметкой.
- style.css - файл со стилями.
- handle.js - объект, осуществляющий общение с пользователем и подключение остальных частей программы
- draw.js - прорисовка и анимация движения манипулятора в браузере (canvas)

Также, для упрощения программной части, используется библиотека jQuery

### Расчет движения из точки в точку (измышления, не реализовавшиеся пока)

Расчет ведется в 3 этапа

- расчет траектории движения активного элемента - поиск пути.
- вычисление углов поворота двигателей и временных рамок, для того, чтобы активный элемент
следовал расчетной траектории с требуемой точностью и условиями.
- оптимизация программы движения.

Расчет траектории ведется по координатной сетке с маленьким шагом. Каждый элемент сетки помечается как
свободный или находящийся внутри препятствия. Требуется "пройти" до ячейки с точкой назначения,
используя соседние свободные по кратчайшему маршруту. После поиска пути производится оптимизация найденного
пути - каждые 2 соседние ячейки объединяются и полученная траектория (прямая) проверяется на
пересечение с препятствиями. Если не пересекаются - делается попытка объединиться со следующей ячейкой.
Если объединенный путь пересекается с препятствиями - он остается без изменения, попытка объединения
продолжается со следующей пары ячеек.
В результате получается ломаная, которую следующим этапом оптимизации
можно заменить гладкой кривой. _Пока в разработке_

Расчет поворота двигателей ведется методом неполного перебора всех возможных значений
угла поворота, с отсечениями. Для каждого этапа расчета выбираем короткий отрезок
расчетной траектории. Функцией оценки считаем расстояние до финальной точки отрезка,
функцией отсечения - повторение уже пройденного положения.
Чтобы не перебирать все возможные углы поворота (возможные ходы), выбираем на каждом шаге только поворот на +- 5 (среднепотолочно)
градусов от текущего значения. 

Оптимизация программы ведется путем объединения соседних команд - полученная траектория движения проверяется на
пересечение с препятствиями и следование граничным условиям

**Примечание:**
Для этапа разработки и предварительной отладки, обход препятствий не учитываются и траекторию движения,
в первом приближении, считаем прямой.
Оптимизация всей программы также не является задачей первого этапа.


